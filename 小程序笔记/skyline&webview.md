# Skyline 与 WebView 渲染引擎

## WebView 下的双线程模型

小程序采用**双线程架构**：

- **逻辑层**：使用 JSCore 执行 JS 逻辑
- **渲染层**：使用 WebView 进行渲染，WXML 和 WXSS 工作在渲染层，每个页面都由单独的 WebView 进行渲染

这两个线程的通信会通过**微信客户端（Native）**进行中转，逻辑层发送的网络请求也由 Native 进行转发。

## WebView 环境下存在的问题

1. **主线程阻塞**：WebView 的 JS 逻辑、DOM 树创建、CSS 解析、样式计算、Layout、Paint（Composite）都发生在同一线程，在 WebView 上执行过多的 JS 逻辑可能阻塞渲染，导致界面卡顿
2. **内存占用高**：每个页面都需要实例化一个 JS 引擎（WebView），导致内存占用多，影响应用性能，因此小程序对打开的页面数量有限制（页面栈最多 10 个）
3. **通信开销大**：页面之间共享资源需要使用 Native 进行通信，会消耗更多性能

## Skyline 渲染引擎

为了进一步优化小程序性能，提供更为接近原生的用户体验，小程序在 WebView 渲染之外新增了 **Skyline 渲染引擎**，旨在解决传统 WebView 渲染模式下主线程过载、响应延迟等问题。

### 核心设计思想

- **逻辑与渲染分离**
- **并行化关键任务**
- **GPU 加速合成**

### 线程架构

在 Skyline 环境下，创建了一条**渲染线程**来负责 Layout、Composite 和 Paint 等渲染任务，并在 AppService 中划出一个独立的上下文，来运行之前 WebView 承担的 JS 逻辑、DOM 树创建等逻辑。

## 三线程协作流程

以一个真实开发场景为例：**用户点击按钮，触发 `setData` 修改文字颜色，页面更新**。

1. **事件捕获**：用户点击按钮 → 渲染线程捕获触摸事件 → 包装成事件数据（"点击了 id=btn 的按钮"）→ 传给 AppService 线程
2. **逻辑处理**：AppService 线程执行 `onTap` 回调 → 调用 `setData({ color: 'red' })` → 修改虚拟节点树的样式属性 → 通知渲染线程"有样式变更"
3. **渲染更新**：渲染线程收到通知 → 重新计算受影响节点的样式（文字颜色变红）→ 重新布局（尺寸不变）→ 生成新的绘制指令（"文字层颜色改为红色"）→ 传给 Raster 线程
4. **光栅化合成**：Raster 线程光栅化新的文字层 → 返回位图 → 渲染线程合成新画面 → 屏幕显示更新后的文字

## WebView vs Skyline 对比

| 特性维度 | 传统 WebView | Skyline 改进 |
| :--- | :--- | :--- |
| **架构模型** | 单线程强耦合，逻辑+渲染在一起，JS 长时间运行会阻塞渲染，导致页面卡顿 | 多线程隔离解耦（AppService 线程、渲染线程、Raster 线程），JS 线程处理数据更新和业务逻辑，渲染线程专注样式计算、布局等，不受 JS 阻塞 |
| **渲染流程** | 依赖 WebView 的渲染管线，严格串行，前一阶段完成后才进入下一阶段 | 阶段重叠执行、多线程协同、分层渲染机制 |
| **通信机制** | 通过 JSBridge 跨进程传输数据，序列化开销大 | AppService 线程与渲染线程数据共享，`setData` 直接操作虚拟节点树（通过 glass-easel 框架实现），通信耗时减少 **50%+** |
| **内存管理** | 每个页面独立 WebView 实例，公共资源重复加载，页面层级最多 10 层 | 多页面共享引擎实例（JS 引擎、渲染引擎），多个 Skyline 页面运行在同一个渲染引擎实例下，支持更细粒度的页面间资源共享。内存占用降低 **30%-50%**，页面跳转耗时减少 **17.6%** |
| **长列表优化** | 全量渲染所有节点，滑动时易掉帧 | Lazy Mount 机制（仅渲染视口内节点）+ 分块光栅化，首次渲染耗时减少 **50%**，滑动时 GPU 加速光栅化，避免白屏和视觉撕裂 |

## 内存（多个页面）
webview和skyline实际实际上都只有一个JS实例，运行js逻辑，webview的渲染层有多个webview实例，skyline只有一个
Page B WebView（事件，生命周期， setData）
  ↓
Native（JSBridge）
  ↓
JS 逻辑层（eventBus.emit）
  ↓
JS 逻辑层（eventBus.on）
  ↓
Native（JSBridge）
  ↓
Page A WebView（setData）

而在skyline下完全不需要JSBridge

